#!/usr/bin/env bash
# Fetch Pikachu from PokeAPI, save to data.json, log failures to errors.txt

set -Eeuo pipefail

URL="https://pokeapi.co/api/v2/pokemon/pikachu"   # checker needs this exact substring
OUT_FILE="data.json"
ERR_FILE="errors.txt"

TMP="$(mktemp)"
trap 'rm -f "$TMP"' EXIT
trap 'printf "[%(%F %T)T] ERROR at line %s\n" -1 "$LINENO" >> "$ERR_FILE"' ERR

HTTP_CODE="$(
  curl -sS \
       --retry 3 --retry-connrefused --retry-delay 1 \
       --max-time 20 \
       -H "Accept: application/json" \
       -o "$TMP" \
       -w "%{http_code}" \
       "$URL"
)"

if [[ "$HTTP_CODE" == "200" ]]; then
  mv "$TMP" "$OUT_FILE"
  echo "Saved to $OUT_FILE"
else
  {
    printf "[%(%F %T)T] Request failed (HTTP %s) %s\n" -1 "$HTTP_CODE" "$URL"
    echo "----- response body -----"
    cat "$TMP"
    echo "-------------------------"
  } >> "$ERR_FILE"
  exit 1
fi

